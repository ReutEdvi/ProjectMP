<!DOCTYPE html>
<html dir="rtl">
<head>
    <meta charset="utf-8" />
    <title></title>
    <link href="style.css" rel="stylesheet" />
    <script src="../Scripts/jquery-3.4.1.min.js"></script>
    <script src="../Scripts/ajaxCalls.js"></script>
    <script src="script.js"></script>

    <script>
        $(document).ready(function () {
            console.log("ready!");
            /*$("#getBTN").click(getItem);
            $("#postBTN").click(postItem);*/

        });

        //function getItem() {

        //    console.log("in getItem");
        //    ajaxCall("GET", "../api/CreateItem", "", getSuccessCB, getErrorCB);
        //}

        function sendPost(msg) {
            let pageId = "104598111726735";
            console.log("trying to get page id from facebook API");
            let user_token = sessionStorage.getItem("token");
            let userID = sessionStorage.getItem("userID");

            //try to get page access token
            let url_get_page_access = "https://graph.facebook.com/" + pageId + "?fields=access_token&access_token=" + user_token;

            let page_acces_token = httpGet(url_get_page_access);
            var resp = JSON.parse(page_acces_token);
            let postUrl = "https://graph.facebook.com/" + pageId + "/feed?message=" + document.getElementById('desc-input').value + "&access_token=" + resp.access_token;

            let res = httpPost(postUrl);

            console.log(res);

        }
        function httpGet(url) {
            var xml = new XMLHttpRequest();
            xml.open('GET', url, false);
            xml.send(null);
            alert(xml.responseText);
            return xml.responseText;
        }
        function httpPost(url) {
            var xml = new XMLHttpRequest();
            xml.open('POST', url, false);
            xml.send();
            return xml.responseText;
        }
        function getSuccessCB(data) {

            alert(data);
            console.log(data);
        }
        function getErrorCB(err) {
            console.log(err);
        }
        //function postItem() {
        //    console.log("in postItem");
        //    let _title = $("#title-input").val();
        //    let _description = $("#desc-input").val();
        //    let CreateItem = {
        //        Title: _title,
        //        Description: _description
        //    }

        //    ajaxCall("POST", "../api/CreateItem", JSON.stringify(CreateItem), postSuccessCB, postErrorCB);
        //}
        function postSuccessCB(data) {
            console.log(data);
        }
        function postErrorCB(err) {
            console.log(err.responseText);
        }


        window.fbAsyncInit = function () {
            FB.init({
                appId: '304468051299771',
                cookie: true,
                xfbml: true,
                version: 'v10.0'
            });


            FB.getLoginStatus(function (response) {
                statusChangeCallback(response);
            });

        };

        (function (d, s, id) {
            var js, fjs = d.getElementsByTagName(s)[0];
            if (d.getElementById(id)) { return; }
            js = d.createElement(s); js.id = id;
            js.src = "https://connect.facebook.net/en_US/sdk.js";
            fjs.parentNode.insertBefore(js, fjs);
        }(document, 'script', 'facebook-jssdk'));

        function statusChangeCallback(response) {
            if (response.status == "connected") {
                console.log("connected")
                sessionStorage.setItem("token", response.authResponse.accessToken);
                sessionStorage.setItem("userID", response.authResponse.userID);
            }
            else {
                console.log("not-connected")
                sessionStorage.clear();
            }

            console.log(response);
        }

        function checkLoginState() {
            FB.getLoginStatus(function (response) {
                statusChangeCallback(response);
            });
        }

    </script>
</head>

    <header>
        <!--<h1>יצירת והעלאת אייטם</h1>-->
    </header>
    <body>

        <!--div>
        <button>העלאת קבצי MP4</button>
        <video width="320" height="240" controls>
            <source src="movie.mp4" type="video/mp4">
            <source src="movie.ogg" type="video/ogg">
            Your browser does not support the video tag.
        </video>

    </div-->
        <div>
            <div id="content-editor">
                <div class="content-form">
                    <div>
                        <label for="title-input-label">שם תכנית</label>
                        <input id="title-input" type="text" name="title-input" value="" />
                    </div>
                    <div>
                        <label for="desc-input">תאור</label>
                        <textarea id="desc-input" name="desc-input" rows="10" cols="40"></textarea>
                    </div>
                    <img src="https://img.icons8.com/fluent/50/000000/twitter.png" />
                    <img src="https://img.icons8.com/fluent/50/000000/facebook-new.png" />
                    <img src="https://img.icons8.com/officel/50/000000/youtube.png" />

                    <fb:login-button scope="public_profile,email"
                                     onlogin="checkLoginState();">
                    </fb:login-button>
                    <!--<button id="getBTN">Get</button>
                    <button id="postBTN">Post</button>-->
                    <button onclick="sendPost('TBD')" id="testBtn">Test Post</button>

                </div>
            </div>
        </div>
        <div>

        </div>

    </body>
</html>